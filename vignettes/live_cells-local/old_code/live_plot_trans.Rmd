---
title: "Transformed Distributions"
author: "Miguel Rodo"
date: "06 June 2019"
output: 
  html_document:
    toc: true
params:
  only_one: true
  reduce: true
---

```{r setup, include=FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "#>", message = FALSE, warning = FALSE)
``` 

```{r setup-libraries, include = FALSE}
library(CytoML)
library(openCyto)
library(ggcyto)
library(magrittr)
library(cowplot)
library(stringr)
library(purrr)
library(dplyr)
filter <- flowCore::filter
```

```{r bv-gradient}
# bivariate
get_rgb_col <- function( red, green, blue ){
  rgb( red = red / 256, green = green / 256, blue = blue / 256 )
}
grad_col_vec <- purrr::map_chr( list( c( 239, 243, 255 ), 
                                      c( 189, 215, 231 ), 
                                      c( 107, 174, 214 ), 
                                      c( 49, 130, 189 ), 
                                      c( 8, 81, 156 ),
                                      c( 5, 75, 134 ),
                                      c( 3, 70, 120 ) ), 
                                function(x){
                                  get_rgb_col( x[[1]], x[[2]], x[[3]])
                                } )
if( !params$reduce ){
  breaks <- c( 0, 1, 100, 1e4, 1e6)
} else{
  breaks <- c( 0, 1, 10, 100, 1e3 )
}
```

```{r function-getFcsFn}
getFn <- function(x){
  if( isClass( x, 'flowFrame' ) ) x <- x@description$FILENAME
  slash_pos_vec <- stringr::str_locate_all( x, "/")[[1]][,1]
  last_slash_pos <- slash_pos_vec[length(slash_pos_vec)]
  x <- stringr::str_sub( x, last_slash_pos + 1, -5 )
  if( stringr::str_sub( x, start = -3 ) == "fcs" ) x <- stringr::str_sub( x, end = -5 )
  x 
}
```

```{r paths, include = FALSE}
path_data <- "/scratch/rdxmig002/data/cytof"
path_in <- file.path( path_data, "ncfs", "singlets" ) 
path_ncfs_dirs_vec <- list.dirs( path_in ) 
if( params$only_one ){
  loop_vec <- path_ncfs_dirs_vec[3]
} else{
  loop_vec <- path_ncfs_dirs_vec[-1]
}
```

```{r data}
fs <- ncdfFlow::load_ncfs( loop_vec )
fr <- fs[[1]]
ex_init <- exprs(fr)
ex_init <- ex_init[,c("Rh103Di", "Ir191Di")]
ex_init <- as.data.frame( ex_init )
```

```{r reduce, eval = params$reduce}
set.seed(1)
samp <- sample( 1:nrow( ex_init ), 1e4, replace = FALSE )
ex_init <- ex_init[samp,]
```

```{r base_plot}
ggplot( ex_init, aes( x = Rh103Di, y = Ir191Di ) ) + 
  geom_hex( bins =  64 ) +
  scale_fill_gradientn( trans = "log10", 
						breaks = breaks,
						colours = grad_col_vec ) +
  labs( title = "No transformations" )
```

```{r ex_scaled}
ub_r <- quantile( ex_init[,"Rh103Di"], 0.98 )
lb_r <- quantile( ex_init[,"Rh103Di"], 0.02 )
print( c( "lb_r" = lb_r, "ub_r" = ub_r) )
range_r <- ub_r - lb_r
print( c( "range_r" = range_r ) )
ub_i <- quantile( ex_init[,"Ir191Di"], 0.98 )
lb_i <- quantile( ex_init[,"Ir191Di"], 0.02 )
print( c( "lb_i" = lb_i, "ub_i" = ub_i) )
range_i <- ub_i - lb_i
print( c( "range_i" = range_i ) )
range_vec <- c( range_r, range_i )
ex_scaled <- as.data.frame( cbind( ex_init$Rh103Di / range_r,
								   ex_init$Ir191Di / range_i ) )
colnames( ex_scaled ) <- c( "Rh103Di", "Ir191Di" )
ggplot( ex_scaled, aes( x = Rh103Di, y = Ir191Di ) ) + 
  geom_hex( bins =  64 ) +
  scale_fill_gradientn( trans = "log10", 
						breaks = breaks,
						colours = grad_col_vec ) +
  labs( title = "Scaled by central 96% interval length" )
```

```{r root}
ex_root <- ex_scaled
ex_root[,"Rh103Di"] = ex_scaled$Rh103Di^(1/ex_init$Ir191Di)
ggplot( ex_root, aes( x = Rh103Di, y = Ir191Di ) ) + 
  geom_hex( bins =  64 ) +
  scale_fill_gradientn( trans = "log10", 
						breaks = breaks,
						colours = grad_col_vec ) +
  labs( title = "Scaled by 1/Ir191Di" )
  ggplot( ex_root, aes( x = Rh103Di ) ) + 
  geom_histogram( bins =  64 )
```

```{r root}
ex_root <- ex_scaled
ex_root[,"Rh103Di"] = ex_scaled$Rh103Di^(1/ex_init$Ir191Di)
ggplot( ex_root, aes( x = Rh103Di, y = Ir191Di ) ) + 
  geom_hex( bins =  64 ) +
  scale_fill_gradientn( trans = "log10", 
						breaks = breaks,
						colours = grad_col_vec ) +
  labs( title = "Scaled by 1/Ir191Di" )
  ggplot( ex_root, aes( x = Rh103Di ) ) + 
  geom_histogram( bins =  64 )
```



```{r plot, results = 'asis', eval = FALSE}
plot_list <- purrr::walk( loop_vec, function(x){
  fs <- ncdfFlow::load_ncfs( x )
  fr <- fs[[1]]
  title <- getFn( fr )
  cat("\n")
  pander::pandoc.header( title, level = 2 )
  cat("\n")
  p0 <- ggcyto( fs, aes( x = Rh103Di ) ) +
          geom_histogram( bins = 50 )
  p0 <- as.ggplot( p0 )
  print(p0)
  p1 <- ggcyto( fs, aes( x = Rh103Di, y = Ir191Di ) ) +
	      geom_hex(bins=128 ) +
		  scale_fill_gradientn( trans = "log10", 
							    breaks = breaks,
							    colours = grad_col_vec )
   p1 <- as.ggplot( p1 )
   print(p1)
} )
```
