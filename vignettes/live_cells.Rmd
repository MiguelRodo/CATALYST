---
title: "live cells"
author: "Miguel Rodo"
date: "06 June 2019"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "#>")
```

```{r setup-libraries, include = FALSE}
library(CytoML)
library(CATALYST)
library(openCyto)
library(ggcyto)
library(magrittr)
library(cowplot)
```

```{r setup-load_data, include = FALSE}
# load data
cluster <- FALSE
save <- TRUE
if( cluster ){
  
      # get vector of absolute file paths to read in 
    path_fcs_folder <- "/scratch/rdxmig002/data/cytof/Normalised/Normalised/"
    path_fcs_file_short_vec <- list.files( path_fcs_folder ) 
    path_fcs_file_vec <- file.path( path_fcs_folder, path_fcs_file_short_vec )
    path_fcs_file_vec <- path_fcs_file_vec[ stringr::str_detect( path_fcs_file_vec, ".fcs" ) ]
    path_fcs_file_vec <- normalizePath( path_fcs_file_vec )

    
  if( save ){
    # read in FCS files and create GatingSet
    ncfs <- read.ncdfFlowSet( path_fcs_file_vec )
    save_ncfs( "/scratch/rdxmig002/data/cytof/Normalised/ncfs" )
  } else{
    ncfs <- load_ncfs( "/scratch/rdxmig002/data/cytof/Normalised/ncfs" )
  }

} else{
  path_pkg <- "C:/Users/migue/Work/PhD/Code/CyTOFACSData-External"
  path_load_gs <- file.path( path_pkg, "inst", "extdata", "gs", "prep_post_trans" )
  gs_prep_trans <- flowWorkspace::load_gs( path_load_gs )
  gs_test <- gs_prep_trans[1]
  fr_init <- getData( gs_test[[1]] ) 
  fr <- fr_init
  ex <- exprs( fr )
  n_row <- nrow( ex )
  set.seed(1)
  row_sample_vec <- sample.int( n = n_row, size = 3e6, replace = FALSE)
  ex_rep <- ex[row_sample_vec,]
  exprs( fr ) <- ex_rep
}

path_fcs <- "C:/Users/migue/Desktop/export_null.fcs"
ncfs_2 <- read.ncdfFlowSet( path_fcs )
gs_2 <- GatingSet( ncfs_2 )
add_pop( gs_2, alias = "live_cells", pop = "-", gating_method = "mindensity2", parent = "root", dims = "CD3" )
  path_pkg <- "C:/Users/migue/Work/PhD/Code/CyTOFACSData-External"
  path_load_gs <- file.path( path_pkg, "inst", "extdata", "gs", "full" )
  gs_prep_trans <- flowWorkspace::load_gs( path_load_gs )
add_pop( gs_prep_trans[1], alias = "live_cells", pop = "-", gating_method = "mindensity2", parent = "root", dims = "CD3" )

```

```{r setup-trans, include = FALSE}
trans <- cluster
```

```{r setup-mass_col_vec, include = FALSE}
get_rgb_col <- function( red, green, blue ){
  rgb( red = red / 256, green = green / 256, blue = blue / 256 )
}
mass_col_vec <- purrr::map_chr( list( c( 27, 158, 119 ), 
                      c( 217, 95, 2 ), 
                      c( 117, 112, 179 ), 
                      c( 231, 41, 138 ), 
                      c( 102, 166, 30 ) ), 
                function(x){
                  get_rgb_col( x[[1]], x[[2]], x[[3]])
                } ) %>%
  setNames( c( "113", "115", "108", "198", "209" ) )
```

```{r setup-db_tbl}
# create debarcoding key
rep_1 <- function(x) rep(1,x)
rep_0 <- function(x) rep(0,x)

db_tbl <- data.frame( `113` = c( rep_1(4), rep_0(6) ), 
                          `115` = c( 1, rep_0(3), rep_1(3), rep_0(3) ), 
                          `108` = c( 0, 1, rep_0(2), 1, rep_0(2), rep_1(2), 0 ), 
                          `198` = c( rep_0(2), 1, rep_0(2), 1, 0, 1, 0, 1 ), 
                          `209` = c( rep_0(3), 1, rep_0(2), 1, 0, rep_1(2) ), 
                      check.names = FALSE)

stim_vec <- c( "uns", "p1", "p4", "mtbaux", "ebv" )
rownames( db_tbl ) <- c( paste0( "pid1_", stim_vec ), 
                         paste0( "pid2_", stim_vec ) )
```

# Remove beads

Remove beads.
```{r beads-remove,results='asis', fig.height = 4, message = FALSE, fig.keep='none'}
if( cluster ){
  for( i in 1:1 ){
      fr <- ncfs[[i]]
      fs <- removeBeads( x = fr, y = "dvs", trans = trans, 
                     out_path = "/scratch/rdxmig002/data/cytof/post_debeading/", 
                     fn = path_fcs_file_short_vec[i], 
                     fn_sep = "/" )  
      }

} else{
  fs <- removeBeads( x = fr, y = "dvs", trans = trans )
}
```

```{r db_fr}
# extract flow frame
fr <- fs[[1]]
``` 

# Live cells

```{r live-pre_bc-gs}
gs_post_bead <- GatingSet( fs )[1]
```

```{r }
# setNode( gs_post_bead, "live_cells", FALSE )
add_pop( gs_post_bead, alias = "live_cells", pop = "-", gating_method = "mindensity2", parent = "root", dims = "Livedead", gating_args = "gate_range = c( 100, 130 )" )
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bead[1], aes( x = Livedead ), 
        subset = "root" ) + 
  geom_density() +
  geom_gate( "live_cells" )
p1 <- ggcyto( gs_post_bead[1], aes( x = Livedead, y = Ir191Di ), 
        subset = "root" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "live_cells" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

# Singlets

```{r }
setNode( gs_post_bead, "singlets_post_live", FALSE )
add_pop( gs_post_bead, alias = "singlets_post_live", pop = "+", gating_method = "flowClust.2d", parent = "live_cells", dims = "Ir191Di,Ir193Di", gating_args = "K = 2, quantile = 0.90" )
```

## Initial flowClust

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "root" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "singlets_post_live" )
p1 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "live_cells" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "singlets_post_live" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() 
p1 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di ), 
        subset = "live_cells" ) + 
  geom_density() 
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

## Post-flowClust Clean



```{r }
setNode( gs_post_bead, "singlets_post_fc_dna1", FALSE )
setNode( gs_post_bead, "singlets_post_fc_dna12", FALSE )
add_pop( gs_post_bead, alias = "singlets_post_fc_dna1", pop = "+", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "gate_range = c(0,20)"  )
add_pop( gs_post_bead, alias = "singlets_post_fc_dna12", pop = "+", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir193Di", gating_args = "gate_range = c(0,20)"  )

add_pop( gs_post_bead, alias = "singlets_post_fc_dna1", pop = "-", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "gate_range = c(100,200)"  )
add_pop( gs_post_bead, alias = "singlets_post_fc_dna12", pop = "-", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir193Di", gating_args = "gate_range = c(100,200)"  )
# high gate
add_pop( gs_post_bead, alias = "singlets_post_fc_dna1", pop = "-", gating_method = "tailgate", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "method = 'second_deriv'"  )
add_pop( gs_post_bead, alias = "singlets_post_fc_dna12", pop = "-", gating_method = "tailgate", parent = "singlets_post_fc_dna1", dims = "Ir193Di", gating_args = "method = 'second_deriv'"  )
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() +
    geom_gate( "singlets_post_fc_dna1" )
p1 <- ggcyto( gs_post_bead[1], aes( x = Ir193Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() +
  geom_gate( "singlets_post_fc_dna12" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "singlets_post_fc_dna12" ) +
  geom_hex( bins = 64 )
p1 <- ggcyto( gs_post_bead[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "live_cells" ) +
  geom_hex( bins = 64 )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

# Debarcode - Normalisation First

## Barcode-specific cutoffs

### Assign to barcode pairs.
```{r bc-f-s-pairs}
# create initial db_frame object
re0 <- assignPrelim( x = fr, y = db_tbl, verbose = TRUE, 
                     trans = FALSE, norm_first = TRUE )
```

#### Estimate cutoffs. 
```{r bc-f-s-est}
# estimate cutoffs
re <- estCutoffs( x = re0 )
```

#### Apply cutoffs. 
```{r bc-f-s-apply}
# apply cutofs
mhl_cutoff( re ) <- 5
re <- applyCutoffs( x = re, sep = 0.25 )
```

#### Write FCS

```{r bc-f-s-out}
out_nms <- stringr::str_c( stringr::str_sub( gs_test[[1]]@name, end = -5 ), "-", names( re@sep_cutoffs ) )
out_path <- file.path( path_pkg, "inst", "extdata", "debarcoded" )
outFCS( x = re, y = fr, out_path = out_path, out_nms = out_nms )
```

# Live cells

Get vector of absolute paths to all the FCS files to read in.
```{r live-path}
path_fcs_folder <- file.path( path_pkg, "inst", "extdata", "debarcoded" ) 
path_fcs_file_short_vec <- list.files( path_fcs_folder ) 
path_fcs_file_vec <- file.path( path_fcs_folder, path_fcs_file_short_vec )
path_fcs_file_vec <- path_fcs_file_vec[ stringr::str_detect( path_fcs_file_vec, ".fcs" ) ]
path_fcs_file_vec <- path_fcs_file_vec[ !stringr::str_detect( path_fcs_file_vec, "Unassigned" ) ]
path_fcs_file_vec <- normalizePath( path_fcs_file_vec )
```

Read in FCS files and create `GatingSet`. 
```{r  prep-full-read}
ncfs <- read.ncdfFlowSet( path_fcs_file_vec )
gs_post_bc <- GatingSet( ncfs )
```

Save `GatingSet` object. 
```{r  prep-full-save}
path_save_gs <- file.path( path_pkg, "inst", "extdata", "gs", "post-debarcoding" )
save_gs( gs_post_bc, path = path_save_gs )
```

```{r }
# setNode( gs_post_bead, "live_cells", FALSE )
add_pop( gs_post_bc, alias = "live_cells", pop = "-", gating_method = "mindensity2", parent = "root", dims = "Livedead", gating_args = "gate_range = c( 100, 130 )" )
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bc[1], aes( x = Livedead ), 
        subset = "root" ) + 
  geom_density() +
  geom_gate( "live_cells" )
p1 <- ggcyto( gs_post_bc[1], aes( x = Livedead, y = Ir191Di ), 
        subset = "root" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "live_cells" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

# Singlets

```{r }
setNode( gs_post_bc, "singlets_post_live", FALSE )
add_pop( gs_post_bc, alias = "singlets_post_live", pop = "+", gating_method = "flowClust.2d", parent = "live_cells", dims = "Ir191Di,Ir193Di", gating_args = "K = 2, quantile = 0.90" )
```

## Initial flowClust

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "root" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "singlets_post_live" )
p1 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "live_cells" ) +
  geom_hex( bins = 64 ) +
  geom_gate( "singlets_post_live" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() 
p1 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di ), 
        subset = "live_cells" ) + 
  geom_density() 
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

## Post-flowClust Clean



```{r }
setNode( gs_post_bc, "singlets_post_fc_dna1", FALSE )
setNode( gs_post_bc, "singlets_post_fc_dna12", FALSE )
add_pop( gs_post_bc, alias = "singlets_post_fc_dna1", pop = "+", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "gate_range = c(0,20)"  )
add_pop( gs_post_bc, alias = "singlets_post_fc_dna12", pop = "+", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir193Di", gating_args = "gate_range = c(0,20)"  )

add_pop( gs_post_bc, alias = "singlets_post_fc_dna1", pop = "-", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "gate_range = c(100,200)"  )
add_pop( gs_post_bc, alias = "singlets_post_fc_dna12", pop = "-", gating_method = "mindensity2", parent = "singlets_post_live", dims = "Ir193Di", gating_args = "gate_range = c(100,200)"  )
# high gate
add_pop( gs_post_bc, alias = "singlets_post_fc_dna1", pop = "-", gating_method = "tailgate", parent = "singlets_post_live", dims = "Ir191Di", gating_args = "method = 'second_deriv'"  )
add_pop( gs_post_bc, alias = "singlets_post_fc_dna12", pop = "-", gating_method = "tailgate", parent = "singlets_post_fc_dna1", dims = "Ir193Di", gating_args = "method = 'second_deriv'"  )
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() +
    geom_gate( "singlets_post_fc_dna1" )
p1 <- ggcyto( gs_post_bc[1], aes( x = Ir193Di ), 
        subset = "singlets_post_live" ) + 
  geom_density() +
  geom_gate( "singlets_post_fc_dna12" )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```

```{r }
for( i in 1:10 ){
  p0 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "singlets_post_fc_dna12" ) +
  geom_hex( bins = 64 )
p1 <- ggcyto( gs_post_bc[1], aes( x = Ir191Di, y = Ir193Di ), 
        subset = "live_cells" ) +
  geom_hex( bins = 64 )
plot_list <- purrr::map( list( p0, p1 ), as.ggplot )
windows()
print( cowplot::plot_grid( plotlist = plot_list, labels = c( "Post beads" ) ) )
}
```
